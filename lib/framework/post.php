<?php
/**
 * Equity Framework
 *
 * WARNING: This file is part of the core Equity Framework. DO NOT edit this file under any circumstances.
 * Please do all modifications in the form of a child theme.
 *
 * @package Equity\Entry
 * @author  IDX, LLC
 * @license GPL-2.0+
 * @link    
 */

/**
 * Restore all default post loop output by re-hooking all default functions.
 *
 * Useful in the event that you need to unhook something in a particular context, but don't want to restore it for all
 * subsequent loop instances.
 *
 * Calls `equity_reset_loops` action after everything has been re-hooked.
 *
 * @since 1.0
 *
 * @global array $_equity_loop_args Associative array for grid loop configuration
 */
function equity_reset_loops() {

	//* HTML5 Hooks
	add_action( 'equity_entry_header', 'equity_entry_header_markup_open', 5 );
	add_action( 'equity_entry_header', 'equity_entry_header_markup_close', 15 );
	add_action( 'equity_entry_header', 'equity_do_post_title' );
	add_action( 'equity_entry_header', 'equity_post_info', 12 );
	
	add_action( 'equity_entry_content', 'equity_do_post_image', 8 );
	add_action( 'equity_entry_content', 'equity_do_post_content' );
	add_action( 'equity_entry_content', 'equity_do_post_content_nav', 12 );
	add_action( 'equity_entry_content', 'equity_do_post_permalink', 14 );
	
	add_action( 'equity_entry_footer', 'equity_entry_footer_markup_open', 5 );
	add_action( 'equity_entry_footer', 'equity_entry_footer_markup_close', 15 );
	add_action( 'equity_entry_footer', 'equity_post_meta' );
	
	add_action( 'equity_after_entry', 'equity_get_comments_template' );

	//* Other
	add_action( 'equity_loop_else', 'equity_do_noposts' );
	add_action( 'equity_after_endwhile', 'equity_posts_nav' );

	//* Reset loop args
	global $_equity_loop_args;
	$_equity_loop_args = array();

	do_action( 'equity_reset_loops' );

}

add_filter( 'post_class', 'equity_entry_post_class' );
/**
 * Add `entry` post class
 *
 * @since 1.0
 *
 * @param array Existing post classes.
 *
 * @return array Amended post classes.
 */
function equity_entry_post_class( $classes ) {

	//* Add "entry" to the post class array
	$classes[] = 'entry';

	return $classes;

}

add_filter( 'post_class', 'equity_custom_post_class', 15 );
/**
 * Add a custom post class, saved as a custom field.
 *
 * @since 1.0
 *
 * @uses equity_get_custom_field() Get custom field value.
 *
 * @param array $classes Existing post classes
 * @return array Amended post classes
 */
function equity_custom_post_class( array $classes ) {

	$new_class = equity_get_custom_field( '_equity_custom_post_class' );

	if ( $new_class )
		$classes[] = esc_attr( $new_class );

	return $classes;

}

add_action( 'equity_entry_header', 'equity_entry_header_markup_open', 5 );
add_action( 'equity_listing_header', 'equity_entry_header_markup_open', 5 );
/**
 * Echo the opening structural markup for the entry header.
 *
 * @since 1.0
 *
 * @uses equity_attr() Contextual attributes.
 */
function equity_entry_header_markup_open() {
	printf( '<header %s>', equity_attr( 'entry-header' ) );
}

add_action( 'equity_entry_header', 'equity_entry_header_markup_close', 15 );
add_action( 'equity_listing_header', 'equity_entry_header_markup_close', 15 );
/**
 * Echo the closing structural markup for the entry header.
 *
 * @since 1.0
 */
function equity_entry_header_markup_close() {
	echo '</header>';
}

add_action( 'equity_entry_header', 'equity_do_post_title' );
add_action( 'equity_listing_header', 'equity_do_post_title' );
/**
 * Echo the title of a post.
 *
 * The `equity_post_title_text` filter is applied on the text of the title, while the `equity_post_title_output`
 * filter is applied on the echoed markup.
 *
 * @since 1.0
 * 
 * @uses equity_markup()         Contextual markup.
 *
 * @return null Return early if the length of the title string is zero.
 */
function equity_do_post_title() {

	$title = apply_filters( 'equity_post_title_text', get_the_title() );

	if ( 0 === mb_strlen( $title ) )
		return;

	//* Link it, if necessary
	if ( ! is_singular() && apply_filters( 'equity_link_post_title', true ) )
		$title = sprintf( '<a href="%s" title="%s" rel="bookmark">%s</a>', get_permalink(), the_title_attribute( 'echo=0' ), $title );

	//* Wrap in H1 on singular pages
	$wrap = is_singular() ? 'h1' : 'h2';

	//* Build the output
	$output = equity_markup( array(
		'html5'   => "<{$wrap} %s>",
		'context' => 'entry-title',
		'echo'    => false,
	) );

	$output .= "{$title}</{$wrap}>";

	echo apply_filters( 'equity_post_title_output', "$output \n" );

}

add_filter( 'equity_post_info', 'do_shortcode', 20 );
add_action( 'equity_entry_header', 'equity_post_info', 12 );
add_action( 'equity_listing_header', 'equity_post_info', 12 );
add_action( 'equity_before_post_content', 'equity_post_info' );
/**
 * Echo the post info (byline) under the post title.
 *
 * By default, only does post info on posts.
 *
 * The post info makes use of several shortcodes by default, and the whole output is filtered via `equity_post_info`
 * before echoing.
 *
 * @since 1.0
 *
 * @uses equity_markup() Contextual markup.
 *
 * @return null Return early if on a page.
 */
function equity_post_info() {

	if ( ! post_type_supports( get_post_type(), 'equity-entry-meta-before-content' ) ) {
		return;
	}

	$output = equity_markup( array(
		'html5'   => '<p %s>',
		'context' => 'entry-meta-before-content',
		'echo'    => false,
	) );

	$output .= apply_filters( 'equity_post_info', '[post_date] ' . __( 'by', 'equity' ) . ' [post_author_posts_link] [post_comments] [post_edit]' );
	$output .= '</p>';

	echo $output;

}

add_action( 'equity_entry_content', 'equity_do_post_image', 8 );
add_action( 'equity_listing_content', 'equity_do_post_image', 8 );
/**
 * Echo the post image on archive pages.
 *
 * If this an archive page and the option is set to show thumbnail, then it gets the image size as per the theme
 * setting, wraps it in the post permalink and echoes it.
 *
 * @since 1.0
 *
 * @uses equity_get_option() Get theme setting value.
 * @uses equity_get_image()  Return an image pulled from the media library.
 * @uses equity_parse_attr() Return contextual attributes.
 */
function equity_do_post_image() {

	if ( ! is_singular() && equity_get_option( 'content_archive_thumbnail' ) ) {
		$img = equity_get_image( array(
			'format'  => 'html',
			'size'    => equity_get_option( 'image_size' ),
			'context' => 'archive',
			'attr'    => equity_parse_attr( 'entry-image' ),
		) );

		if ( ! empty( $img ) )
			printf( '<a href="%s" title="%s">%s</a>', get_permalink(), the_title_attribute( 'echo=0' ), $img );
	}

}

add_action( 'equity_entry_content', 'equity_do_post_content' );
add_action( 'equity_listing_content', 'equity_do_post_content' );
/**
 * Echo the post content.
 *
 * On single posts or pages it echoes the full content, and optionally the trackback string if enabled. On single pages,
 * also adds the edit link after the content.
 *
 * Elsewhere it displays either the excerpt, limited content, or full content.
 *
 * Applies the `equity_edit_post_link` filter.
 *
 * @since 1.0
 *
 * @uses equity_get_option() Get theme setting value.
 * @uses the_content_limit()  Limited content.
 */
function equity_do_post_content() {

	if ( is_singular() ) {
		the_content();

		if ( is_single() && 'open' === get_option( 'default_ping_status' ) && post_type_supports( get_post_type(), 'trackbacks' ) ) {
			echo '<!--';
			trackback_rdf();
			echo '-->' . "\n";
		}

		if ( is_page() && apply_filters( 'equity_edit_post_link', true ) )
			edit_post_link( __( '(Edit)', 'equity' ), '', '' );
	}
	elseif ( 'excerpts' === equity_get_option( 'content_archive' ) ) {
		the_excerpt();
	}
	else {
		if ( equity_get_option( 'content_archive_limit' ) )
			the_content_limit( (int) equity_get_option( 'content_archive_limit' ), __( 'Continue reading...', 'equity' ) );
		else
			the_content( __( 'Continue reading...', 'equity' ) );
	}

}

add_action( 'equity_entry_content', 'equity_do_post_content_nav', 12 );
add_action( 'equity_listing_content', 'equity_do_post_content_nav', 12 );
/**
 * Display page links for paginated posts (i.e. includes the <!--nextpage--> Quicktag one or more times).
 *
 * @since 1.0
 *
 * @uses equity_markup() Contextual markup.
 */
function equity_do_post_content_nav() {

	wp_link_pages( array(
		'before' => equity_markup( array(
				'html5'   => '<div %s>',
				'context' => 'entry-pagination',
				'echo'    => false,
			) ) . __( 'Pages:', 'equity' ),
		'after'  => '</div>',
	) );

}

add_action( 'equity_entry_content', 'equity_do_post_permalink', 14 );
add_action( 'equity_listing_content', 'equity_do_post_permalink', 14 );
/**
 * Show permalink if no title.
 *
 * If the entry has no title, this is a way to display a link to the full post.
 *
 * Applies the `equity_post_permalink` filter.
 *
 * @since 1.0
 */
function equity_do_post_permalink() {

	//* Don't show on singular views, or if the entry has a title
	if ( is_singular() || get_the_title() )
		return;

	$permalink = get_permalink();

	echo apply_filters( 'equity_post_permalink', sprintf( '<p class="entry-permalink"><a href="%s" title="%s" rel="bookmark">%s</a></p>', esc_url( $permalink ), __( 'Permalink', 'equity' ), esc_html( $permalink ) ) );

}

add_action( 'equity_loop_else', 'equity_do_noposts' );
/**
 * Show help if admin and no posts found, else show no results found text and search form
 *
 * @since 1.0
 */
function equity_do_noposts() {

	if ( is_home() && current_user_can( 'publish_posts' ) ) :

		printf( __( '<div class="entry"><p>Ready to publish your first post? <a href="%1$s">Get started here</a>.</p></div>', 'equity' ), esc_url( admin_url( 'post-new.php' ) ) );

	elseif ( is_search() ) :

		_e( '<div class="entry"><p>Sorry, but nothing matched your search terms. Please try again with some different keywords.</p></div>', 'equity' );
		get_search_form();

	else :

		_e( '<div class="entry"><p>It seems we can&rsquo;t find what you&rsquo;re looking for. Perhaps searching can help.</p></div>', 'equity' );
		get_search_form();

	endif;
}

add_action( 'equity_entry_footer', 'equity_entry_footer_markup_open', 5 );
add_action( 'equity_listing_footer', 'equity_entry_footer_markup_open', 5 );
/**
 * Echo the opening structural markup for the entry footer.
 *
 * @since 1.0
 *
 * @uses equity_attr() Contextual attributes.
 */
function equity_entry_footer_markup_open() {

	if ( 'post' === get_post_type() )
		printf( '<footer %s>', equity_attr( 'entry-footer' ) );

}

add_action( 'equity_entry_footer', 'equity_entry_footer_markup_close', 15 );
add_action( 'equity_listing_footer', 'equity_entry_footer_markup_close', 15 );
/**
 * Echo the closing structural markup for the entry footer.
 *
 * @since 1.0
 */
function equity_entry_footer_markup_close() {

	if ( 'post' === get_post_type() )
		echo '</footer>';

}

add_filter( 'equity_post_meta', 'do_shortcode', 20 );
add_action( 'equity_entry_footer', 'equity_post_meta' );
add_action( 'equity_listing_footer', 'equity_post_meta' );
/**
 * Echo the post meta after the post content.
 *
 * Doesn't do post meta on pages.
 *
 * The post meta makes use of a couple of shortcodes by default, and the whole output is filtered via
 * `equity_post_meta` before echoing.
 *
 * @since 1.0
 *
 * @uses equity_markup() Contextual markup.
 *
 * @global WP_Post $post Post object.
 *
 * @return null Return early if on a page
 */
function equity_post_meta() {

	if ( 'page' === get_post_type() )
		return;

	$output = equity_markup( array(
		'html5'   => '<p %s>',
		'context' => 'entry-meta-after-content',
		'echo'    => false,
	) );

	$output .= apply_filters( 'equity_post_meta', '[post_terms] [post_tags]' );
	$output .= '</p>';

	echo $output;

}

add_action( 'equity_after_entry', 'equity_do_author_box_single', 8 );
/**
 * Conditionally add the author box after single posts or pages.
 *
 * @since 1.3
 *
 * @uses equity_author_box() Echo the author box.
 *
 * @return null Return early if not a single post or page.
 */
function equity_do_author_box_single() {

	if ( ! is_single() )
		return;

	if ( get_the_author_meta( 'equity_author_box_single', get_the_author_meta( 'ID' ) ) )
		equity_author_box( 'single' );

}

/**
 * Echo the the author box and its contents.
 *
 * The title is filterable via `equity_author_box_title`, and the gravatar size is filterable via
 * `equity_author_box_gravatar_size`.
 *
 * The final output is filterable via `equity_author_box`, which passes many variables through.
 *
 * @since 1.3
 * 
 * @uses equity_attr()  Contextual attributes.
 *
 * @global WP_User $authordata Author (user) object.
 *
 * @param string $context Optional. Allows different author box markup for different contexts, specifically 'single'.
 *                        Default is empty string.
 * @param bool   $echo    Optional. If true, the author box will echo. If false, it will be returned.
 *
 * @return string HTML for author box.
 */
function equity_author_box( $context = '', $echo = true ) {

	global $authordata;

	$authordata    = is_object( $authordata ) ? $authordata : get_userdata( get_query_var( 'author' ) );
	$gravatar_size = apply_filters( 'equity_author_box_gravatar_size', 70, $context );
	$gravatar      = get_avatar( get_the_author_meta( 'email' ), $gravatar_size );
	$description   = wpautop( do_shortcode( get_the_author_meta( 'description' ) ) );

	//* The author box markup, contextual

	$title = __( 'About', 'equity' ) . ' <span itemprop="name">' . get_the_author() . '</span>';

	/**
	 * Author box title filter.
	 * 
	 * Allows you to filter the title of the author box. $context passed as second parameter to allow for contextual filtering.
	 *
	 * @since unknown
	 * 
	 * @param string $title Assembled Title.
	 * @param string $context Context. 
	 */
	$title = apply_filters( 'equity_author_box_title', $title, $context );

	$pattern  = sprintf( '<section %s>', equity_attr( 'author-box' ) );
	if ( 'single' === $context ) {
		$pattern .= '%s<h4 class="author-box-title">%s</h4>';
	} else {
		$pattern .= '%s<h1 class="author-box-title">%s</h1>';
	}
	$pattern .= '<div class="author-box-content" itemprop="description">%s</div>';
	$pattern .= '</section>';


	$output = sprintf( $pattern, $gravatar, $title, $description );

	/**
	 * Author box output filter.
	 * 
	 * Allows you to filter the full output of the author box.
	 *
	 * @since unknown
	 * 
	 * @param string $output Assembled output.
	 * @param string $context Context.
	 * @param string $pattern (s)printf pattern. 
	 * @param string $context Gravatar. 
	 * @param string $context Title. 
	 * @param string $context Description. 
	 */
	$output = apply_filters( 'equity_author_box', $output, $context, $pattern, $gravatar, $title, $description );

	if ( $echo )
		echo $output;
	else
		return $output;

}

add_action( 'equity_after_entry', 'equity_after_entry_widget_area' );
/**
 * Conditionally add after entry widget area
 * @since  1.0
 */
function equity_after_entry_widget_area() {
	if ( is_active_sidebar( 'after-entry' ) && is_single() ) {
		equity_markup( array(
			'html5'   => '<aside %s>',
			'context' => 'after-entry-widget-area',
		) );

			dynamic_sidebar( 'after-entry' );

		equity_markup( array(
			'html5' => '</aside>',
		) );
	}
}

add_action( 'equity_after_endwhile', 'equity_posts_nav' );
/**
 * Conditionally echo archive pagination in a format dependent on chosen setting.
 *
 * This is shown at the end of archives to get to another page of entries.
 *
 * @since 1.0
 *
 * @uses equity_get_option()            Get theme setting value.
 * @uses equity_prev_next_posts_nav()   Prev and Next links.
 * @uses equity_numeric_posts_nav()     Numbered links.
 */
function equity_posts_nav() {

	if ( is_single() ) {
		equity_prev_next_post_nav();
	} elseif ( 'prev-next' === equity_get_option( 'posts_nav' ) ) {
		equity_prev_next_posts_nav();
	} else {
		equity_numeric_posts_nav();
	}

}

/**
 * Echo archive pagination in Previous Posts / Next Posts format.
 *
 * Applies `equity_prev_link_text` and `equity_next_link_text` filters.
 *
 * @since 1.0
 */
function equity_prev_next_posts_nav() {

	$prev_link = get_previous_posts_link( apply_filters( 'equity_prev_link_text', '&#x000AB;' . __( ' Previous Page', 'equity' ) ) );
	$next_link = get_next_posts_link( apply_filters( 'equity_next_link_text', __( 'Next Page ', 'equity' ) . '&#x000BB;' ) );

	$prev = $prev_link ? '<div class="pagination-previous alignleft">' . $prev_link . '</div>' : '';
	$next = $next_link ? '<div class="pagination-next alignright">' . $next_link . '</div>' : '';

	$nav = equity_markup( array(
		'html5'   => '<nav %s><div class="archive-nav-links">',
		'context' => 'archive-pagination',
		'echo'    => false,
	) );

	$nav .= '<h3 class="screen-reader-text">' . __( 'Posts navigation', 'equity' ) . '</h3>';
	$nav .= $prev;
	$nav .= $next;
	$nav .= '</div><!-- end .archive-nav-links --></nav>';

	if ( $prev || $next )
		echo $nav;
}

/**
 * Echo archive pagination in page numbers format.
 *
 * Applies the `equity_prev_link_text` and `equity_next_link_text` filters.
 *
 * The links, if needed, are ordered as:
 *
 *  * previous page arrow,
 *  * first page,
 *  * up to two pages before current page,
 *  * current page,
 *  * up to two pages after the current page,
 *  * last page,
 *  * next page arrow.
 *
 * @since 1.0
 *
 * @global WP_Query $wp_query Query object.
 *
 * @return null Return early if on a single post or page, or only one page present.
 */
function equity_numeric_posts_nav() {

	if( is_singular() )
		return;

	global $wp_query;

	//* Stop execution if there's only 1 page
	if( $wp_query->max_num_pages <= 1 )
		return;

	$paged = get_query_var( 'paged' ) ? absint( get_query_var( 'paged' ) ) : 1;
	$max   = intval( $wp_query->max_num_pages );

	//* Add current page to the array
	if ( $paged >= 1 )
		$links[] = $paged;

	//* Add the pages around the current page to the array
	if ( $paged >= 3 ) {
		$links[] = $paged - 1;
		$links[] = $paged - 2;
	}

	if ( ( $paged + 2 ) <= $max ) {
		$links[] = $paged + 2;
		$links[] = $paged + 1;
	}

	equity_markup( array(
		'html5'   => '<nav %s><div class="archive-nav-links">',
		'context' => 'archive-pagination',
	) );

	echo '<h3 class="screen-reader-text">' . __( 'Posts navigation', 'equity' ) . '</h3>';

	echo '<ul class="pagination">';

	//* Previous Post Link
	if ( get_previous_posts_link() )
		printf( '<li class="pagination-previous">%s</li>' . "\n", get_previous_posts_link( apply_filters( 'equity_prev_link_text', '&#x000AB;' . __( ' Previous Page', 'equity' ) ) ) );

	//* Link to first page, plus ellipses if necessary
	if ( ! in_array( 1, $links ) ) {

		$class = 1 == $paged ? ' class="active current"' : '';

		printf( '<li%s><a href="%s">%s</a></li>' . "\n", $class, esc_url( get_pagenum_link( 1 ) ), '1' );

		if ( ! in_array( 2, $links ) )
			echo '<li class="pagination-omission unavailable">&#x02026;</li>';

	}

	//* Link to current page, plus 2 pages in either direction if necessary
	sort( $links );
	foreach ( (array) $links as $link ) {
		$class = $paged == $link ? ' class="active current"' : '';
		printf( '<li%s><a href="%s">%s</a></li>' . "\n", $class, esc_url( get_pagenum_link( $link ) ), $link );
	}

	//* Link to last page, plus ellipses if necessary
	if ( ! in_array( $max, $links ) ) {

		if ( ! in_array( $max - 1, $links ) )
			echo '<li class="pagination-omission unavailable">&#x02026;</li>' . "\n";

		$class = $paged == $max ? ' class="active current"' : '';
		printf( '<li%s><a href="%s">%s</a></li>' . "\n", $class, esc_url( get_pagenum_link( $max ) ), $max );

	}

	//* Next Post Link
	if ( get_next_posts_link() )
		printf( '<li class="pagination-next">%s</li>' . "\n", get_next_posts_link( apply_filters( 'equity_next_link_text', __( 'Next Page ', 'equity' ) . '&#x000BB;' ) ) );

	echo '</ul></div><!-- end .archive-nav-links --></nav>' . "\n";

}

/**
 * Display links to previous and next post, from a single post.
 *
 * @since 1.0
 *
 * @return null Return early if not a post.
 */
function equity_prev_next_post_nav() {

	// Don't print empty markup if there's nowhere to navigate.
	$previous = ( is_attachment() ) ? get_post( get_post()->post_parent ) : get_adjacent_post( false, '', true );
	$next     = get_adjacent_post( false, '', false );

	if ( ! $next && ! $previous ) {
		return;
	}

	equity_markup( array(
		'html5'   => '<nav %s><div class="post-nav-links">',
		'context' => 'adjacent-entry-pagination',
	) );

	echo '<h3 class="screen-reader-text">' . __( 'Post navigation', 'equity' ) . '</h3>';

	echo '<div class="pagination-previous alignleft">';
	previous_post_link();
	echo '</div>';

	echo '<div class="pagination-next alignright">';
	next_post_link();
	echo '</div>';

	echo '</div><!-- end .post-nav-links --> </nav>';

}